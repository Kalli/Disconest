// Generated by CoffeeScript 1.8.0
var SearchCollection, SearchCollectionView, SearchResultModel, SearchResultView;

SearchResultModel = Backbone.Model.extend({});

SearchResultView = Backbone.View.extend({
  tagName: "li",
  attributes: {
    tabindex: -1
  },
  initialize: function() {
    return this.render();
  },
  render: function() {
    return this.$el.html(this.template(this.model.toJSON()));
  },
  template: _.template("<a href=\"\">\n    <img width=\"50\" height=\"50\" src=\"<%= thumb %>\" />\n    <%= title %>\n</a>"),
  events: {
    "click": "release"
  },
  release: function(e) {
    var parameters;
    e.preventDefault();
    $('#release').hide();
    $('#results').hide(1000);
    parameters = {
      id: this.model.attributes.id,
      type: this.model.attributes.type + "s"
    };
    return getMetaData(parameters);
  }
});

SearchCollection = Backbone.Collection.extend({
  tag: "div",
  model: SearchResultModel,
  initialize: function(props) {
    this.url = "/discogs?url=https://api.discogs.com/database/search?q=" + props.query + "&type=master";
  },
  parse: function(response) {
    var releases, result, _i, _len, _ref;
    releases = [];
    _ref = response.results;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      result = _ref[_i];
      if (result.type === "release" || result.type === "master") {
        releases.push(result);
      }
    }
    response.results = releases;
    return response.results;
  }
});

SearchCollectionView = Backbone.View.extend({
  events: {
    "click .showmore": "showmore",
    "keydown .showmore": "showmore"
  },
  showmore: function(e) {
    var hidden, index, release, _i, _len, _results;
    e.preventDefault();
    if (e.which === 13 || e.which === 1) {
      hidden = $(".hidden");
      _results = [];
      for (index = _i = 0, _len = hidden.length; _i < _len; index = ++_i) {
        release = hidden[index];
        if (index < 10) {
          $(release).show();
          _results.push($(release).removeClass("hidden"));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    }
  },
  tagName: 'div',
  id: 'results',
  template: _.template("<ul id=\"searchCollection\" class=\"col-md-12 dropdown-menu\" role=\"menu\" tabindex=\"1\" aria-labelledby=\"searchform\">\n</ul>"),
  render: function() {
    $('#' + this.id).html(this.template({}));
    this.collection.each((function(_this) {
      return function(searchResultModel, index) {
        var searchResultView, show;
        searchResultView = new SearchResultView({
          model: searchResultModel
        });
        if (show = index > 4) {
          searchResultView.$el.addClass("hidden");
        }
        return _this.$el.find("#searchCollection").append(searchResultView.$el);
      };
    })(this));
    if (this.collection.length > 4) {
      this.$el.find("#searchCollection").append('<li class="divider"></li>');
      this.$el.find("#searchCollection").append('<li><a class="showmore" href="">Show more</a></li>');
    }
    $('#' + this.id).show();
    return this;
  }
});
