// Generated by CoffeeScript 1.6.3
(function() {
  $(document).ready(function() {
    var discogsCallback, echonestCallback, getDiscogsInformation, getEchonestInformation, getTracklist, renderDiscogsInformation, renderError;
    getDiscogsInformation = function(id, type) {
      var url,
        _this = this;
      url = "/discogs?url=http://api.discogs.com/" + type + "/" + id;
      return $.ajax({
        dataType: "json",
        url: url,
        data: [],
        success: function(response) {
          return discogsCallback(response);
        }
      });
    };
    discogsCallback = function(response) {
      renderDiscogsInformation(response);
      return getTracklist("#tltable");
    };
    renderDiscogsInformation = function(context) {
      var html, source, template;
      source = $("#release-template").html();
      template = Handlebars.compile(source);
      html = template(context);
      return $("#release").html(html);
    };
    getTracklist = function(tltable) {
      return $(tltable + ' tbody').find('tr').each(function(index, element) {
        return getEchonestInformation(index, $(element).data());
      });
    };
    getEchonestInformation = function(index, data) {
      var url,
        _this = this;
      url = 'http://developer.echonest.com/api/v4/song/search?api_key=BB7QVYHAMYUOT4ESL&format=json&results=1&artist_id=discogs:artist:' + data.artistid + '&title=' + data.title + '&bucket=audio_summary';
      return $.ajax({
        dataType: "json",
        url: url,
        data: [],
        success: function(response) {
          return echonestCallback(index, response.response);
        }
      });
    };
    echonestCallback = function(index, response) {
      var audio_summary, html;
      audio_summary = response.songs[0].audio_summary;
      html = "";
      html += '<td>' + audio_summary.key + '</td>';
      html += '<td>' + audio_summary.time_signature + '</td>';
      html += '<td>' + audio_summary.tempo + '</td>';
      return $($('#tltable tbody tr')[index]).append(html);
    };
    Handlebars.registerHelper('tracklist', function(tracks, artists, videos, options) {
      var artist, h, header, out, track, trackartist, trackartistid, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1;
      out = "<h3>Tracklist</h3>";
      out += '<table id="tltable" class="table">';
      header = '<thead>';
      _ref = ['position', 'duration', 'artist', 'title', 'key', 'time signature', 'bpm'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        h = _ref[_i];
        header += '<td>' + h + '</td>';
      }
      out += header + '</thead>';
      for (_j = 0, _len1 = tracks.length; _j < _len1; _j++) {
        track = tracks[_j];
        trackartist = '';
        trackartistid = '';
        if (track.artists) {
          _ref1 = track.artists;
          for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {
            artist = _ref1[_k];
            trackartist = artist.name + artist.join;
            trackartistid = artist.id;
          }
        } else {
          for (_l = 0, _len3 = artists.length; _l < _len3; _l++) {
            artist = artists[_l];
            trackartist = artist.name + artist.join;
            trackartistid = artist.id;
          }
        }
        out += '<tr data-artistid="' + trackartistid + '" data-title="' + track.title + '">';
        out += '<td>' + track.position + '</td>';
        out += '<td>' + track.duration + '</td>';
        out += '<td >' + trackartist + '</td>';
        out += '<td >' + track.title + '</td>';
        out += '</tr>';
      }
      out += '</table>';
      return out;
    });
    $('#getmetadata').click(function() {
      var matches, regexp, url;
      url = $('#discogsurl').val();
      regexp = /(?:https?:\/\/)?(?:www.)?discogs.com\/.*?\/(release|master)\/(\d+)/;
      matches = url.match(regexp);
      if (matches && matches.length === 3) {
        return getDiscogsInformation(matches[2], matches[1] + "s");
      } else {
        return renderError(url);
      }
    });
    return renderError = function(url) {
      var html, source, template;
      source = $("#error-template").html();
      template = Handlebars.compile(source);
      html = template({
        "url": url,
        "error": " is not a valid Discogs release url!"
      });
      return $("#error").html(html);
    };
  });

}).call(this);
